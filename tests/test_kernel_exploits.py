"""Tests for the kernel exploit suggestion database and lookup functions."""

from __future__ import annotations

import pytest

from lazyssh.plugins._kernel_exploits import (
    KERNEL_EXPLOITS,
    KernelExploit,
    _parse_kernel_version,
    _version_in_range,
    suggest_exploits,
)


class TestKernelExploitDataIntegrity:
    """Validate that every entry in KERNEL_EXPLOITS has valid data."""

    def test_database_is_nonempty(self) -> None:
        assert len(KERNEL_EXPLOITS) > 0

    def test_all_entries_have_nonempty_fields(self) -> None:
        for entry in KERNEL_EXPLOITS:
            assert entry.cve, f"Empty CVE in {entry}"
            assert entry.name, f"Empty name in {entry}"
            assert entry.description, f"Empty description in {entry}"
            assert entry.reference_url, f"Empty reference_url in {entry}"
            assert len(entry.min_version) >= 2, f"min_version too short in {entry.cve}"
            assert len(entry.max_version) >= 2, f"max_version too short in {entry.cve}"

    def test_min_not_greater_than_max(self) -> None:
        for entry in KERNEL_EXPLOITS:
            assert entry.min_version <= entry.max_version, (
                f"{entry.cve}: min_version {entry.min_version} > max_version {entry.max_version}"
            )

    def test_cve_format(self) -> None:
        for entry in KERNEL_EXPLOITS:
            assert entry.cve.startswith("CVE-"), f"Invalid CVE format: {entry.cve}"

    def test_reference_urls_are_https(self) -> None:
        for entry in KERNEL_EXPLOITS:
            assert entry.reference_url.startswith("https://"), (
                f"Non-HTTPS URL in {entry.cve}: {entry.reference_url}"
            )

    def test_entries_are_frozen(self) -> None:
        entry = KERNEL_EXPLOITS[0]
        with pytest.raises(AttributeError):
            entry.cve = "modified"  # type: ignore[misc]


class TestParseKernelVersion:
    """Tests for _parse_kernel_version."""

    def test_simple_version(self) -> None:
        assert _parse_kernel_version("5.10.100") == (5, 10, 100)

    def test_version_with_suffix(self) -> None:
        assert _parse_kernel_version("5.10.100-generic") == (5, 10, 100)

    def test_ubuntu_style_version(self) -> None:
        assert _parse_kernel_version("4.15.0-213-generic") == (4, 15, 0)

    def test_two_component_version(self) -> None:
        assert _parse_kernel_version("5.4") == (5, 4)

    def test_single_number(self) -> None:
        assert _parse_kernel_version("6") == (6,)

    def test_leading_whitespace(self) -> None:
        assert _parse_kernel_version("  5.10.100-generic  ") == (5, 10, 100)

    def test_empty_string(self) -> None:
        assert _parse_kernel_version("") is None

    def test_no_digits(self) -> None:
        assert _parse_kernel_version("not-a-version") is None

    def test_complex_suffix(self) -> None:
        assert _parse_kernel_version("5.4.0-42-generic") == (5, 4, 0)

    def test_long_version(self) -> None:
        assert _parse_kernel_version("5.10.100.1.2") == (5, 10, 100, 1, 2)


class TestVersionInRange:
    """Tests for _version_in_range."""

    def test_exact_min(self) -> None:
        assert _version_in_range((5, 8, 0), (5, 8, 0), (5, 16, 10)) is True

    def test_exact_max(self) -> None:
        assert _version_in_range((5, 16, 10), (5, 8, 0), (5, 16, 10)) is True

    def test_within_range(self) -> None:
        assert _version_in_range((5, 10, 50), (5, 8, 0), (5, 16, 10)) is True

    def test_below_range(self) -> None:
        assert _version_in_range((5, 7, 99), (5, 8, 0), (5, 16, 10)) is False

    def test_above_range(self) -> None:
        assert _version_in_range((5, 16, 11), (5, 8, 0), (5, 16, 10)) is False

    def test_different_major(self) -> None:
        assert _version_in_range((4, 10, 0), (5, 8, 0), (5, 16, 10)) is False

    def test_shorter_tuple_below(self) -> None:
        # (5, 4) < (5, 4, 1) is True in Python tuple comparison
        assert _version_in_range((5, 4), (5, 4, 1), (5, 16, 10)) is False

    def test_shorter_tuple_in_range(self) -> None:
        assert _version_in_range((5, 10), (5, 8, 0), (5, 16, 10)) is True


class TestSuggestExploits:
    """Tests for suggest_exploits."""

    def test_dirty_pipe_match(self) -> None:
        """Kernel 5.10.100 should match Dirty Pipe (5.8.0 - 5.16.10)."""
        results = suggest_exploits("5.10.100-generic")
        cves = {e.cve for e in results}
        assert "CVE-2022-0847" in cves

    def test_dirty_cow_match(self) -> None:
        """Kernel 4.4.0 should match Dirty COW (2.6.22 - 4.8.2)."""
        results = suggest_exploits("4.4.0-42-generic")
        cves = {e.cve for e in results}
        assert "CVE-2016-5195" in cves

    def test_very_old_kernel(self) -> None:
        """Kernel 2.6.22 should match Dirty COW."""
        results = suggest_exploits("2.6.22")
        cves = {e.cve for e in results}
        assert "CVE-2016-5195" in cves

    def test_very_new_kernel_no_matches(self) -> None:
        """A very new kernel should match fewer or no exploits."""
        results = suggest_exploits("6.12.0")
        # Should not match old exploits like Dirty COW or Dirty Pipe
        cves = {e.cve for e in results}
        assert "CVE-2016-5195" not in cves
        assert "CVE-2022-0847" not in cves

    def test_unparseable_version(self) -> None:
        """Non-version strings should return empty list."""
        assert suggest_exploits("not-a-version") == []

    def test_empty_version(self) -> None:
        assert suggest_exploits("") == []

    def test_whitespace_version(self) -> None:
        assert suggest_exploits("   ") == []

    def test_multiple_matches(self) -> None:
        """Kernel 5.10.0 should match multiple exploits."""
        results = suggest_exploits("5.10.0")
        assert len(results) >= 3  # Should match Dirty Pipe, Netfilter, nf_tables, etc.

    def test_returns_kernel_exploit_instances(self) -> None:
        results = suggest_exploits("5.10.0")
        for result in results:
            assert isinstance(result, KernelExploit)

    def test_boundary_dirty_pipe_min(self) -> None:
        """Kernel 5.8.0 is exact min of Dirty Pipe — should match."""
        results = suggest_exploits("5.8.0")
        cves = {e.cve for e in results}
        assert "CVE-2022-0847" in cves

    def test_boundary_dirty_pipe_below_min(self) -> None:
        """Kernel 5.7.99 is below Dirty Pipe min — should not match."""
        results = suggest_exploits("5.7.99")
        cves = {e.cve for e in results}
        assert "CVE-2022-0847" not in cves

    def test_boundary_dirty_pipe_max(self) -> None:
        """Kernel 5.16.10 is exact max of Dirty Pipe — should match."""
        results = suggest_exploits("5.16.10")
        cves = {e.cve for e in results}
        assert "CVE-2022-0847" in cves

    def test_boundary_dirty_pipe_above_max(self) -> None:
        """Kernel 5.16.11 is above Dirty Pipe max — should not match."""
        results = suggest_exploits("5.16.11")
        cves = {e.cve for e in results}
        assert "CVE-2022-0847" not in cves
