"""Kernel exploit suggestion database for LazySSH enumeration.

This module contains a curated database of well-known Linux kernel privilege
escalation CVEs with affected version ranges. The ``suggest_exploits()``
function parses a running kernel version string and returns matching entries
whose affected range contains that version.

No network access is required at runtime — all data is embedded.
"""

from __future__ import annotations

import re
from dataclasses import dataclass


@dataclass(frozen=True)
class KernelExploit:
    """A known kernel privilege-escalation vulnerability."""

    cve: str
    name: str
    min_version: tuple[int, ...]
    max_version: tuple[int, ...]
    description: str
    reference_url: str


def _parse_kernel_version(version_string: str) -> tuple[int, ...] | None:
    """Extract a numeric version tuple from a kernel version string.

    Handles common formats:
    - ``5.10.100``
    - ``5.10.100-generic``
    - ``4.15.0-213-generic``
    - ``5.4.0-42-generic``
    - ``6.1.0``

    Returns ``None`` when no version numbers can be extracted.
    """
    match = re.match(r"(\d+(?:\.\d+)*)", version_string.strip())
    if not match:
        return None
    parts = match.group(1).split(".")
    return tuple(int(p) for p in parts)


def _version_in_range(
    version: tuple[int, ...],
    min_ver: tuple[int, ...],
    max_ver: tuple[int, ...],
) -> bool:
    """Return ``True`` when *version* falls within [min_ver, max_ver] inclusive.

    Tuples of different lengths are compared element-wise; shorter tuples are
    logically padded with zeros for the comparison (Python's default tuple
    comparison handles this correctly because ``(5, 4) < (5, 4, 1)``).
    """
    return min_ver <= version <= max_ver


def suggest_exploits(kernel_version: str) -> list[KernelExploit]:
    """Return kernel exploits whose affected range contains *kernel_version*.

    *kernel_version* is a raw ``uname -r`` output string such as
    ``"5.10.100-generic"``.  Returns an empty list when the version cannot be
    parsed or no exploits match.
    """
    parsed = _parse_kernel_version(kernel_version)
    if parsed is None:
        return []

    matches: list[KernelExploit] = []
    for exploit in KERNEL_EXPLOITS:
        if _version_in_range(parsed, exploit.min_version, exploit.max_version):
            matches.append(exploit)
    return matches


# ---------------------------------------------------------------------------
# Exploit database — curated from public CVE advisories
# ---------------------------------------------------------------------------

KERNEL_EXPLOITS: tuple[KernelExploit, ...] = (
    # CVE-2022-0847 — Dirty Pipe
    KernelExploit(
        cve="CVE-2022-0847",
        name="Dirty Pipe",
        min_version=(5, 8, 0),
        max_version=(5, 16, 10),
        description=(
            "Allows overwriting data in arbitrary read-only files. "
            "Can be used to inject code into SUID binaries for instant root."
        ),
        reference_url="https://dirtypipe.cm4all.com/",
    ),
    # CVE-2016-5195 — Dirty COW
    KernelExploit(
        cve="CVE-2016-5195",
        name="Dirty COW",
        min_version=(2, 6, 22),
        max_version=(4, 8, 2),
        description=(
            "Race condition in mm/huge_memory.c allows local users to gain "
            "privileges by writing to a copy-on-write memory mapping."
        ),
        reference_url="https://dirtycow.ninja/",
    ),
    # CVE-2021-4034 — PwnKit (pkexec)
    KernelExploit(
        cve="CVE-2021-4034",
        name="PwnKit",
        min_version=(2, 6, 0),
        max_version=(5, 17, 0),
        description=(
            "Memory corruption in polkit's pkexec (SUID binary) allows any "
            "unprivileged local user to gain full root privileges. "
            "Kernel-version-independent but commonly listed for scoping."
        ),
        reference_url="https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034",
    ),
    # CVE-2021-3493 — Overlayfs
    KernelExploit(
        cve="CVE-2021-3493",
        name="Overlayfs Privilege Escalation",
        min_version=(4, 4, 0),
        max_version=(5, 11, 0),
        description=(
            "Improper validation of user namespaces in overlayfs on Ubuntu "
            "kernels allows local privilege escalation."
        ),
        reference_url="https://ubuntu.com/security/CVE-2021-3493",
    ),
    # CVE-2022-25636 — Netfilter heap-out-of-bounds
    KernelExploit(
        cve="CVE-2022-25636",
        name="Netfilter Heap OOB Write",
        min_version=(5, 4, 0),
        max_version=(5, 16, 10),
        description=(
            "Heap out-of-bounds write in nf_dup_netdev.c allows local "
            "privilege escalation via crafted netfilter rules."
        ),
        reference_url="https://nvd.nist.gov/vuln/detail/CVE-2022-25636",
    ),
    # CVE-2021-3156 — Baron Samedit (sudo but kernel-adjacent)
    KernelExploit(
        cve="CVE-2021-3156",
        name="Baron Samedit",
        min_version=(2, 6, 0),
        max_version=(5, 17, 0),
        description=(
            "Heap-based buffer overflow in sudo's argument parsing. "
            "Affects sudo 1.8.2-1.8.31p2 and 1.9.0-1.9.5p1. "
            "Kernel-version-independent; version range is permissive for scoping."
        ),
        reference_url="https://blog.qualys.com/vulnerabilities-threat-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit",
    ),
    # CVE-2021-3560 — Polkit D-Bus auth bypass
    KernelExploit(
        cve="CVE-2021-3560",
        name="Polkit D-Bus Authentication Bypass",
        min_version=(4, 0, 0),
        max_version=(5, 13, 0),
        description=(
            "Authentication bypass in polkit via premature D-Bus request "
            "cancellation. Allows creating privileged local accounts."
        ),
        reference_url="https://github.blog/security/vulnerability-research/privilege-escalation-polkit-root-on-linux-with-bug/",
    ),
    # CVE-2021-33909 — Sequoia
    KernelExploit(
        cve="CVE-2021-33909",
        name="Sequoia",
        min_version=(3, 16, 0),
        max_version=(5, 13, 3),
        description=(
            "Size_t-to-int conversion vulnerability in the filesystem layer "
            "allows local privilege escalation via crafted deep directory structures."
        ),
        reference_url="https://blog.qualys.com/vulnerabilities-threat-research/2021/07/20/sequoia-a-local-privilege-escalation-vulnerability-in-linuxs-filesystem-layer-cve-2021-33909",
    ),
    # CVE-2023-2640 + CVE-2023-32629 — GameOver(lay)
    KernelExploit(
        cve="CVE-2023-2640",
        name="GameOver(lay)",
        min_version=(5, 15, 0),
        max_version=(6, 2, 0),
        description=(
            "Ubuntu-specific OverlayFS privilege escalation. "
            "Improperly sets permissions on upper directory allowing "
            "unprivileged users to set privileged extended attributes."
        ),
        reference_url="https://www.wiz.io/blog/ubuntu-overlayfs-vulnerability",
    ),
    # CVE-2023-4911 — Looney Tunables (glibc ld.so)
    KernelExploit(
        cve="CVE-2023-4911",
        name="Looney Tunables",
        min_version=(4, 0, 0),
        max_version=(6, 6, 0),
        description=(
            "Buffer overflow in glibc's dynamic loader (ld.so) GLIBC_TUNABLES "
            "environment variable processing. Kernel-version-independent; "
            "range is permissive for scoping. Requires glibc >= 2.34."
        ),
        reference_url="https://blog.qualys.com/vulnerabilities-threat-research/2023/10/03/cve-2023-4911-looney-tunables-local-privilege-escalation-in-the-glibcs-ld-so",
    ),
    # CVE-2022-2588 — nf_tables use-after-free
    KernelExploit(
        cve="CVE-2022-2588",
        name="nf_tables Use-After-Free",
        min_version=(3, 18, 0),
        max_version=(5, 19, 0),
        description=(
            "Use-after-free in net/netfilter/nf_tables_api.c allows local "
            "privilege escalation via crafted nf_tables set operations."
        ),
        reference_url="https://nvd.nist.gov/vuln/detail/CVE-2022-2588",
    ),
    # CVE-2022-0185 — Heap overflow in legacy_parse_param
    KernelExploit(
        cve="CVE-2022-0185",
        name="Filesystem Context Heap Overflow",
        min_version=(5, 1, 0),
        max_version=(5, 16, 1),
        description=(
            "Heap overflow in legacy_parse_param in fs/fs_context.c allows "
            "container escape and local privilege escalation."
        ),
        reference_url="https://nvd.nist.gov/vuln/detail/CVE-2022-0185",
    ),
    # CVE-2022-34918 — nf_tables type confusion
    KernelExploit(
        cve="CVE-2022-34918",
        name="nf_tables Type Confusion",
        min_version=(5, 8, 0),
        max_version=(5, 18, 8),
        description=(
            "Type confusion in nft_set_elem_init allows heap buffer overflow "
            "leading to local privilege escalation."
        ),
        reference_url="https://nvd.nist.gov/vuln/detail/CVE-2022-34918",
    ),
    # CVE-2022-2639 — openvswitch integer underflow
    KernelExploit(
        cve="CVE-2022-2639",
        name="OpenVSwitch Reserve Underflow",
        min_version=(5, 0, 0),
        max_version=(5, 19, 0),
        description=(
            "Integer underflow in openvswitch module leads to out-of-bounds "
            "write and local privilege escalation."
        ),
        reference_url="https://nvd.nist.gov/vuln/detail/CVE-2022-2639",
    ),
    # CVE-2023-0386 — OverlayFS copy-up flaw
    KernelExploit(
        cve="CVE-2023-0386",
        name="OverlayFS Copy-Up SUID",
        min_version=(5, 11, 0),
        max_version=(6, 2, 0),
        description=(
            "OverlayFS copy-up operation preserves SUID bits from lower "
            "filesystem, allowing privilege escalation via user namespaces."
        ),
        reference_url="https://nvd.nist.gov/vuln/detail/CVE-2023-0386",
    ),
    # CVE-2023-32233 — nf_tables UAF via anonymous sets
    KernelExploit(
        cve="CVE-2023-32233",
        name="nf_tables Anonymous Set UAF",
        min_version=(5, 0, 0),
        max_version=(6, 3, 1),
        description=(
            "Use-after-free in Netfilter nf_tables when processing anonymous "
            "sets allows local privilege escalation."
        ),
        reference_url="https://nvd.nist.gov/vuln/detail/CVE-2023-32233",
    ),
    # CVE-2022-0995 — watch_queue out-of-bounds write
    KernelExploit(
        cve="CVE-2022-0995",
        name="watch_queue OOB Write",
        min_version=(5, 8, 0),
        max_version=(5, 17, 0),
        description=(
            "Out-of-bounds write in watch_queue event notification subsystem "
            "allows local privilege escalation."
        ),
        reference_url="https://nvd.nist.gov/vuln/detail/CVE-2022-0995",
    ),
    # CVE-2024-1086 — nf_tables use-after-free (nft_verdict_init)
    KernelExploit(
        cve="CVE-2024-1086",
        name="nf_tables Verdict UAF",
        min_version=(3, 15, 0),
        max_version=(6, 7, 1),
        description=(
            "Use-after-free in nft_verdict_init allows local privilege "
            "escalation. Highly reliable exploit available."
        ),
        reference_url="https://nvd.nist.gov/vuln/detail/CVE-2024-1086",
    ),
)
